name: Deploy to Pi

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'k8s/**'
  workflow_dispatch:

env:
  NAMESPACE: smart-alarm
  DOCKER_REGISTRY: daymonpollet
  IMAGE_TAG: latest

jobs:
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64,linux/amd64
      
      - uses: docker/setup-buildx-action@v3
      
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - uses: docker/build-push-action@v5
        with:
          context: ./backend/local-api
          file: ./backend/local-api/Dockerfile
          platforms: linux/arm64,linux/amd64
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/smart-alarm-backend:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64,linux/amd64
      
      - uses: docker/setup-buildx-action@v3
      
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          platforms: linux/arm64,linux/amd64
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/smart-alarm-frontend:${{ env.IMAGE_TAG }}
          build-args: |
            REACT_APP_API_URL=/api
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: [build-backend, build-frontend]
    runs-on: [self-hosted, Linux, ARM64]
    steps:
      - uses: actions/checkout@v4

      - name: Create namespace
        run: kubectl apply -f k8s/base/namespace.yaml

      - name: Create secrets
        run: |
          kubectl create secret generic smart-alarm-secrets \
            --namespace=${{ env.NAMESPACE }} \
            --from-literal=FITBIT_CLIENT_ID="${{ secrets.FITBIT_CLIENT_ID }}" \
            --from-literal=FITBIT_CLIENT_SECRET="${{ secrets.FITBIT_CLIENT_SECRET }}" \
            --from-literal=FITBIT_ACCESS_TOKEN="${{ secrets.FITBIT_ACCESS_TOKEN }}" \
            --from-literal=FITBIT_REFRESH_TOKEN="${{ secrets.FITBIT_REFRESH_TOKEN }}" \
            --from-literal=AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            --from-literal=IOTHUB_CONNECTION_STRING="${{ secrets.IOTHUB_CONNECTION_STRING }}" \
            --from-literal=AZURE_ENDPOINT_URL="${{ secrets.AZURE_ENDPOINT_URL }}" \
            --from-literal=AZURE_ENDPOINT_KEY="${{ secrets.AZURE_ENDPOINT_KEY }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Setup storage
        run: |
          sudo mkdir -p /data/smart-alarm/data /data/smart-alarm/model
          sudo chown -R 1000:1000 /data/smart-alarm
          kubectl apply -f k8s/base/configmap.yaml
          kubectl apply -f k8s/base/storage.yaml

      - name: Deploy backend
        run: |
          sed "s|\${DOCKER_REGISTRY}|${{ env.DOCKER_REGISTRY }}|g; s|\${IMAGE_TAG}|${{ env.IMAGE_TAG }}|g" \
            k8s/base/backend-deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/base/backend-service.yaml

      - name: Deploy frontend
        run: |
          sed "s|\${DOCKER_REGISTRY}|${{ env.DOCKER_REGISTRY }}|g; s|\${IMAGE_TAG}|${{ env.IMAGE_TAG }}|g" \
            k8s/base/frontend-deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/base/frontend-service.yaml
          kubectl apply -f k8s/base/ingress.yaml

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/smart-alarm-backend -n ${{ env.NAMESPACE }} --timeout=300s || true
          kubectl rollout status deployment/smart-alarm-frontend -n ${{ env.NAMESPACE }} --timeout=300s || true

      - name: Show status
        if: always()
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide
          kubectl get svc -n ${{ env.NAMESPACE }}
