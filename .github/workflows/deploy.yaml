# Deploy to Raspberry Pi Kubernetes
# This workflow is ONLY triggered manually - no automatic deploys
# This prevents issues with partial builds or race conditions
name: Deploy to Pi

on:
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'Deployment strategy'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - canary
          - rollback
          - promote
      image_tag:
        description: 'Image tag for both frontend and backend'
        required: false
        default: 'latest'
      canary_weight:
        description: 'Canary traffic weight % (only for canary deploy)'
        required: false
        default: '20'

env:
  NAMESPACE: smart-alarm
  DOCKER_REGISTRY: daymonpollet

jobs:
  deploy:
    name: Deploy (${{ github.event.inputs.deployment_type }})
    runs-on: [self-hosted, pi]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image tag
        id: config
        run: |
          TAG="${{ github.event.inputs.image_tag }}"
          echo "Using image tag: ${TAG}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # ============================================
      # FULL DEPLOYMENT
      # ============================================
      - name: "[Full] Create namespace"
        if: github.event.inputs.deployment_type == 'full'
        run: kubectl apply -f k8s/base/namespace.yaml

      - name: "[Full] Create/Update secrets"
        if: github.event.inputs.deployment_type == 'full'
        run: |
          kubectl create secret generic smart-alarm-secrets \
            --namespace=${{ env.NAMESPACE }} \
            --from-literal=FITBIT_CLIENT_ID="${{ secrets.FITBIT_CLIENT_ID }}" \
            --from-literal=FITBIT_CLIENT_SECRET="${{ secrets.FITBIT_CLIENT_SECRET }}" \
            --from-literal=FITBIT_ACCESS_TOKEN="${{ secrets.FITBIT_ACCESS_TOKEN }}" \
            --from-literal=FITBIT_REFRESH_TOKEN="${{ secrets.FITBIT_REFRESH_TOKEN }}" \
            --from-literal=AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            --from-literal=IOTHUB_CONNECTION_STRING="${{ secrets.IOTHUB_CONNECTION_STRING }}" \
            --from-literal=AZURE_ENDPOINT_URL="${{ secrets.AZURE_ENDPOINT_URL }}" \
            --from-literal=AZURE_ENDPOINT_KEY="${{ secrets.AZURE_ENDPOINT_KEY }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: "[Full] Setup storage"
        if: github.event.inputs.deployment_type == 'full'
        run: |
          sudo mkdir -p /data/smart-alarm/data /data/smart-alarm/model
          sudo chown -R 1000:1000 /data/smart-alarm
          kubectl apply -f k8s/base/configmap.yaml
          kubectl apply -f k8s/base/storage.yaml

      - name: "[Full] Deploy backend"
        if: github.event.inputs.deployment_type == 'full'
        run: |
          sed "s|\${DOCKER_REGISTRY}|${{ env.DOCKER_REGISTRY }}|g; s|\${IMAGE_TAG}|${{ steps.config.outputs.tag }}|g" \
            k8s/base/backend-deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/base/backend-service.yaml

      - name: "[Full] Deploy frontend"
        if: github.event.inputs.deployment_type == 'full'
        run: |
          sed "s|\${DOCKER_REGISTRY}|${{ env.DOCKER_REGISTRY }}|g; s|\${IMAGE_TAG}|${{ steps.config.outputs.tag }}|g" \
            k8s/base/frontend-deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/base/frontend-service.yaml
          kubectl apply -f k8s/base/ingress.yaml

      - name: "[Full] Wait for rollout"
        if: github.event.inputs.deployment_type == 'full'
        run: |
          echo "Waiting for backend..."
          kubectl rollout status deployment/smart-alarm-backend -n ${{ env.NAMESPACE }} --timeout=300s || true
          echo "Waiting for frontend..."
          kubectl rollout status deployment/smart-alarm-frontend -n ${{ env.NAMESPACE }} --timeout=300s || true

      # ============================================
      # CANARY DEPLOYMENT
      # ============================================
      - name: "[Canary] Verify stable exists"
        if: github.event.inputs.deployment_type == 'canary'
        run: |
          if ! kubectl get deployment smart-alarm-backend -n ${{ env.NAMESPACE }} 2>/dev/null; then
            echo "ERROR: No stable deployment found. Run 'full' deployment first."
            exit 1
          fi

      - name: "[Canary] Deploy canary pods"
        if: github.event.inputs.deployment_type == 'canary'
        run: |
          sed "s|\${DOCKER_REGISTRY}|${{ env.DOCKER_REGISTRY }}|g; s|\${CANARY_TAG}|${{ steps.config.outputs.tag }}|g" \
            k8s/canary/backend-canary.yaml | kubectl apply -f -
          sed "s|\${DOCKER_REGISTRY}|${{ env.DOCKER_REGISTRY }}|g; s|\${CANARY_TAG}|${{ steps.config.outputs.tag }}|g" \
            k8s/canary/frontend-canary.yaml | kubectl apply -f -

      - name: "[Canary] Configure traffic split"
        if: github.event.inputs.deployment_type == 'canary'
        run: |
          WEIGHT="${{ github.event.inputs.canary_weight }}"
          sed "s|canary-weight: \"20\"|canary-weight: \"${WEIGHT}\"|g" \
            k8s/canary/traffic-split.yaml | kubectl apply -f -

      - name: "[Canary] Wait for rollout"
        if: github.event.inputs.deployment_type == 'canary'
        run: |
          kubectl rollout status deployment/smart-alarm-backend-canary -n ${{ env.NAMESPACE }} --timeout=300s || true
          kubectl rollout status deployment/smart-alarm-frontend-canary -n ${{ env.NAMESPACE }} --timeout=300s || true

      # ============================================
      # ROLLBACK (remove canary)
      # ============================================
      - name: "[Rollback] Remove canary deployments"
        if: github.event.inputs.deployment_type == 'rollback'
        run: |
          kubectl delete deployment smart-alarm-backend-canary -n ${{ env.NAMESPACE }} --ignore-not-found
          kubectl delete deployment smart-alarm-frontend-canary -n ${{ env.NAMESPACE }} --ignore-not-found
          kubectl delete service smart-alarm-backend-weighted -n ${{ env.NAMESPACE }} --ignore-not-found
          kubectl delete ingress smart-alarm-canary -n ${{ env.NAMESPACE }} --ignore-not-found
          echo "Canary rolled back. All traffic now goes to stable."

      # ============================================
      # PROMOTE (canary becomes stable)
      # ============================================
      - name: "[Promote] Get canary image"
        if: github.event.inputs.deployment_type == 'promote'
        id: canary_image
        run: |
          BACKEND=$(kubectl get deployment smart-alarm-backend-canary -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "")
          FRONTEND=$(kubectl get deployment smart-alarm-frontend-canary -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "")
          if [ -z "$BACKEND" ]; then
            echo "ERROR: No canary deployment found to promote"
            exit 1
          fi
          echo "backend=${BACKEND}" >> $GITHUB_OUTPUT
          echo "frontend=${FRONTEND}" >> $GITHUB_OUTPUT

      - name: "[Promote] Update stable to canary version"
        if: github.event.inputs.deployment_type == 'promote'
        run: |
          kubectl set image deployment/smart-alarm-backend backend=${{ steps.canary_image.outputs.backend }} -n ${{ env.NAMESPACE }}
          kubectl set image deployment/smart-alarm-frontend frontend=${{ steps.canary_image.outputs.frontend }} -n ${{ env.NAMESPACE }}
          kubectl rollout status deployment/smart-alarm-backend -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/smart-alarm-frontend -n ${{ env.NAMESPACE }} --timeout=300s

      - name: "[Promote] Remove canary"
        if: github.event.inputs.deployment_type == 'promote'
        run: |
          kubectl delete deployment smart-alarm-backend-canary -n ${{ env.NAMESPACE }} --ignore-not-found
          kubectl delete deployment smart-alarm-frontend-canary -n ${{ env.NAMESPACE }} --ignore-not-found
          kubectl delete service smart-alarm-backend-weighted -n ${{ env.NAMESPACE }} --ignore-not-found
          kubectl delete ingress smart-alarm-canary -n ${{ env.NAMESPACE }} --ignore-not-found

      # ============================================
      # STATUS (always runs)
      # ============================================
      - name: Show deployment status
        if: always()
        run: |
          echo ""
          echo "============================================"
          echo "         DEPLOYMENT STATUS"
          echo "============================================"
          echo ""
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide 2>/dev/null || echo "No pods found"
          echo ""
          kubectl get svc -n ${{ env.NAMESPACE }} 2>/dev/null || echo "No services found"
          echo ""
          NODE_PORT=$(kubectl get svc smart-alarm-frontend -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "N/A")
          PI_IP=$(hostname -I | awk '{print $1}')
          echo "============================================"
          echo "Access URL: http://${PI_IP}:${NODE_PORT}"
          echo "============================================"
