name: Deploy Local Model Service

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/python-model-service/**'
      - '.github/workflows/deploy-model.yml'

jobs:
  deploy:
    # Running on a self-hosted runner is fine, but the setup must be clean
    runs-on: self-hosted 
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      
    # -----------------------------------------------------
    # 1. New Step: Setup Python (Good Practice for self-hosted)
    #    This ensures the correct Python executable is available.
    # -----------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x' # Or specify a fixed version like '3.10'
        
    # -----------------------------------------------------
    # 2. Updated Step: Install dependencies using venv
    #    This resolves the "externally-managed-environment" error.
    # -----------------------------------------------------
    - name: Install dependencies
      working-directory: ./backend/python-model-service
      run: |
        echo "Creating virtual environment..."
        # 1. Create a virtual environment named '.venv'
        python3 -m venv .venv
        
        echo "Activating virtual environment and installing packages..."
        # 2. Activate the virtual environment
        source .venv/bin/activate
        
        # 3. Use the venv's isolated 'pip' to install dependencies
        pip install -r requirements.txt
    
    # check and train model if not exist
    - name: Check and train model
      working-directory: ./backend/python-model-service
      # The 'source .venv/bin/activate' step is NOT needed here 
      # if we explicitly call the executable inside the venv folder.
      run: |
        PYTHON_EXEC=./.venv/bin/python
        
        if [ ! -f model.joblib ]; then
          echo "Training model..."
          $PYTHON_EXEC train_model.py
        else
          echo "Model already exists"
        fi
        
    # a final verification
    - name: Verify model service is running
      run: |
        if curl -f http://localhost:5000/ 2>/dev/null; then
          echo "Model service is running"
        else
          echo "Warning: Model service not running. Please start manually."
        fi